---
layout: post
title: "Android Security: Beware of the default IV!"
---

A quick one today. 

A couple of people I have spoken to recently have been unaware of the need to ensure a random IV is being used when performing AES encryption on Android.

_What is an IV?_

> In cryptography, an initialization vector (IV) or starting variable (SV)[1] is a fixed-size input to a cryptographic primitive that is typically required to be random or pseudorandom. Randomization is crucial for encryption schemes to achieve semantic security, a property whereby repeated usage of the scheme under the same key does not allow an attacker to infer relationships between segments of the encrypted message. For block ciphers, the use of an IV is described by the modes of operation. _[Wikipedia](https://en.wikipedia.org/wiki/Initialization_vector)_

The unawareness seems to fall into two camps:

1. I didn't know I needed to use an IV
2. I am using the IV that is generated by the Cipher

## I didn't know I needed to use an IV

[Yup!](https://security.stackexchange.com/questions/35210/encrypting-using-aes-256-do-i-need-iv/35216#35216)

## I am using the IV that is generated by the Cipher

Potentially an [Uh oh!](https://stackoverflow.com/questions/31036780/android-cryptography-api-not-generating-safe-iv-for-aes)

Poking around a little, I can see that on old versions of Android (tested 4.3) the `AndroidOpenSSL` provider can return an all `0` IV with the below, whereas the same code on 7 will spit out seemingly-random IVs.

```
byte[] key = new byte[16];
new SecureRandom().nextBytes(key);
SecretKeySpec skeySpec = new SecretKeySpec(key, "AES");
Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding", "AndroidOpenSSL");
cipher.init(Cipher.ENCRYPT_MODE, key);
byte[] cipherBytes = cipher.doFinal(s.getBytes("UTF-8"));
byte[] iv = cipher.getIV();
```

Using the newer `KeyGenParameterSpec` APIs and the `AndroidKeyStore` Provider seems to be fine regarding this issue from the small amount of testing I have done. The IV is prepended to the ciphered output `bytes[]` by default.

[`isRandomizedEncryptionRequired()`](https://developer.android.com/reference/android/security/keystore/KeyGenParameterSpec.html#isRandomizedEncryptionRequired()) exists if you want to menually ensure the IV is randomised, otherwise `cipher.init` will throw if an IV is supplied.

## Enforcing a random IV

It's worth explicitly declaring an IV to avoid the vulns introduced with either of the above two approaches. This can be as simple as:

<div data-gist-id="2ce511580419cdcec7ec2ef886e91e4f">1</div>

[Some](https://developer.android.com/reference/javax/crypto/Cipher.html) of the Android examples do now suggest this, but I find it can be easy to forget when looking at [other](https://developer.android.com/reference/android/security/keystore/KeyGenParameterSpec.html) example code.

_If interested in Android security take a look at [doridori/Android-Security-Reference](https://github.com/doridori/Android-Security-Reference)_




